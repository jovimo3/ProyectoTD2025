---
  title: "MEMORIA TRATAMIENTO DE DATOS\\newline"

author: "Laura Horjales Rivas, Arnau Hernández Lucas, Josep Vicent Morales Martorell,\\newline Rocío Bono Moreno y Pau García Pérez."
date: "2025-05-10"
output:
  pdf_document:
  latex_engine: xelatex
toc: yes
toc_depth: 4
number_sections: no
fig_caption: yes
html_document:
  toc: yes
toc_depth: 3
df_print: paged
header-includes:
  - \usepackage[labelfont=bf,justification=raggedright,singlelinecheck=false]{caption}
- \usepackage{lineno}

---
  
  
```{r setup, include=FALSE} 
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, error = FALSE)
```

```{r, results='hide'} 
install.packages("gridExtra", repos="https://cran.rstudio.com/")
```

```{r results='hide', include=FALSE}
library(pdftools)
library(tidyr)
library(dplyr)
library(ggplot2)
library(stringr)
library(lubridate)
```

\newpage

\nolinenumbers

# Introducción

# Contexto del proyecto

\linenumbers
En la actualidad donde la información ha pasado a ser uno de los elementos más preciados, el análisis de datos juega un papel muy importante tanto en la toma de decisiones estratégicas como operativas. La gran cantidad de datos ha impulsado la necesidad de convertir estos mismos en conocimientos aplicables, lo que convierte el análisis exploratorio en una herramienta esencial en múltiples sectores.

Como futuros científicos de datos, nuestro trabajo consistirá en extraer la información más relevante de una gran cantidad de datos. En este proyecto, los tickets representaran nuestra fuente de datos, donde mediante estos, podremos descubrir: preferencias, hábitos y comportamientos de los consumidores. A través de ellos, también podemos interpretar patrones ocultos, prever necesidades futuras y generar estrategias que optimicen tanto la experiencia del cliente como la gestión empresarial.

Analizando los registros de venta recogidos en los tickets, es posible obtener conclusiones relevantes para áreas como el control de inventario, el diseño de promociones o la personalización de servicios. Esto no solo mejora la eficiencia interna, sino que permite responder de forma ágil y efectiva a las demandas del mercado.

\nolinenumbers
## Nuestro Proyecto

\linenumbers
Este proyecto nace con la necesidad de convertir datos sin procesar - provenientes de tickets de Mercadona- en información valiosa mediante técnicas de limpieza, transformación y análisis exploratorio. A través de una serie de scripts en R, hemos diseñado un modelo de trabajo que permite capturar los aspectos más relevantes del consumo cotidiano, con el objetivo de ofrecer herramientas útiles para la toma de decisiones comerciales.


La metodología utilizada combina la programación en R con recursos de visualización y manipulación de datos. Nuestro trabajo no se limita en organizar los datos, sino que busca identificar correlaciones, tendencias y patrones de comportamiento. A través de este proceso, contribuimos al entendimiento de dinámicas reales del mercado y fomentamos un entorno donde el dato procesado se convierte en una ventaja competitiva.

\nolinenumbers
## Recursos utilizados y estructura de trabajo

\linenumbers

Para llevar a cabo este análisis, hemos empleado librerías fundamentales de R como readr, dplyr, stringr, tibble y ggplot2, entre otras. Estas herramientas nos han permitido estructurar los datos de manera eficiente, realizar filtrados específicos, transformar cadenas de texto y crear visualizaciones útiles.

El proceso inicial incluyó la conversión de los archivos PDF a texto plano mediante el uso de las funciones de la librería pdftools. Luego, se procedió a extraer la información de interés, organizándola en dataframes preparados para su análisis posterior. Una parte esencial fue la limpieza de los datos: corregir errores, homogeneizar formatos y validar los campos esenciales para obtener un dataset sólido y confiable.

\nolinenumbers
## Variables y estruturas de los datos

\linenumbers


En esta primera fase, trabajamos con un conjunto de diferentes variables , que abarcan tanto información general del ticket (fecha, hora, importe total, tienda, caja, número de ticket) como detalles específicos de los productos adquiridos (nombre del producto, cantidad, precio unitario, tipo de producto, peso o unidad, entre otros).
\newpage

\nolinenumbers
## Características generales de nuestros datos y nuestras variables
\linenumbers

texto
```{r, results='hide'}



```

\nolinenumbers
## LISTADO DE PREGUNTAS PLANTEADAS:
\linenumbers

1.-¿Cuáles son los 5 productos, de los vendidos por unidades, con más ventas ? ¿Cuántas unidades de cada uno se han vendido ?

2.-Si consideramos la categoría de FRUTAS Y VERDURAS. Cuáles son los 5 productos más vendidos ? ¿Cuántos kilos se han vendido de cada uno de estos productos ? 

3.-Si consideramos la categoría de PESCADO. Cuáles son los 5 productos más vendidos ? ¿Cuántos kilos se han vendido de cada uno de estos productos ? 

4.-Muestra mediante un gráfico de líneas como ha variado el precio por kilo de las bananas y los plátanos en los tickets disponibles, a lo largo del tiempo.

5.-¿Cuál es la procedencia de los tickets ?¿ Qué ciudad/ pueblo tiene un mayor número de tickets ? 

6.-Muestra mediante un diagrama el número de tickets recogidos cada día de las semana. ¿Si tuvieses que cerrar un día entre semana qué día lo harías? 

7.-¿Cuál es la hora más habitual para realizar la compra? ¿Este horario varía entre los días laborales y los fines de semana?

8.-¿Existe alguna diferencia clara en el perfil de compra entre los días de semana y los fines de semana?

9.-¿El precio total de la compra varían según la ciudad o zona?

10.-¿Cuánto dinero de media se gasta cada cliente en una compra?

11.-¿Cuál es el mes o período en el que más gastos se realizan? ¿Durante las vacaciones de navidad? 

12.-¿Qué productos suelen comprarse juntos?

13.-¿Cuál es el producto más caro registrado en los tickets?

14.-¿Hay una cantidad  media de productos por tickets? 

15.-¿Qué productos son los más comprados en las diferentes partes del día: mañana, tarde y noche?

16.-¿Que productos son los más comprados durante las diferentes estaciones, verano (1 de junio - 31 de agosto),  invierno(21 diciembre - 20 marzo)... ? (representación gráfica)

17.-¿En que estación se compra más?¿Por que crees que és?

18.-¿Cuánto supone económicamente de media el IVA en las compras?

19.-¿De los 5 productos más comprados, cual de ellos ha subido más el precio?¿y cual ha bajado más su precio? 

20.- ¿En que se ha gastado(€) más en pescado o en otros productos que van por peso? ¿Es equivalente al número de veces que se han comprado unidades de estos?

21.-¿Hay una relación entre la cantidad de productos que se compra y si ha utilizado el parking o no? 

22.-¿Cual es el tiempo medio que tardan en hacer la compra las personas que han utilizado el parking? 

\newpage

## Preguntas obligatorias:
\nolinenumbers


**Pregunta 1 : ¿Cuáles son los 5 productos, de los vendidos por unidades, con más ventas ? ¿Cuántas unidades de cada uno se han vendido?**

\linenumbers

Realizando el análisis de top 5 ventas del Mercadona, podemos observar que los 5 productos más vendidos por unidades son: el atún claro oliva(62 unidades), queso lonchas cabra( 53 unidades), bolsa plástico (51 unidades), leche desnatada de calcio (49 unidades) y, por último, yogur coco (40 unidades). Este resultado, muestra una gran tendencia hacia los lácteos ya que 3 de estos 5 productos son lácteos.

```{r}

# Primero Filtramos solo los productos vendidos por unidades, es decir, los que no son ni fruta,verdura y pescado(!Tipo == "Fruta o Verdura" o "Pescado")
df_unidades <- df_p %>%
  filter(!Tipo %in% c("Fruta o Verdura", "Pescado")) %>%
  mutate(Cantidad = as.numeric(Cantidad)) 

# Luego agrupamos por producto y sumamos las cantidades
productos_ventas <- df_unidades %>%
  group_by(Descripcion) %>%
  summarise(Total_Unidades_Vendidas = sum(Cantidad, na.rm = TRUE)) %>%
  arrange(desc(Total_Unidades_Vendidas)) 

# Seleccionamos los 5 productos con más ventas
top_5_productos <- head(productos_ventas, 5)

top_5_productos

```

\nolinenumbers

**Pregunta 2: Si consideramos la categoría de FRUTAS Y VERDURAS. Cuáles son los 5 productos más vendidos ? ¿Cuántos kilos se han vendido de cada uno de estos productos?**

\linenumbers

Dentro de la categoría de FRUTAS y VERDURAS los 5 productos más vendidos son: el plátano (vendiendo un total de 62.868 kg), la banana 
(28.140 kg), la sandia baja semillas (22.843 kg), el pepino (19.624 kg) y el calabacín verde (17.754 kg). 

```{r}
# Filtramos los productos que entren en la categoría "Frutas y Verduras".
df_frutas_verduras <- df_p %>%
  filter(Tipo == "Fruta o Verdura") %>%
  mutate(Peso = as.numeric(Peso))  

# A continuación agrupamos los productos y sumamos los kilos vendidos.
frutas_verduras_ventas <- df_frutas_verduras %>%
  group_by(Descripcion) %>%
  summarise(total_kilos_vendidos = sum(Peso, na.rm = TRUE)) %>%
  arrange(desc(total_kilos_vendidos))

# Seleccionamos los 5 productos con más kilos vendidos.
top5_frutas_verduras <- head(frutas_verduras_ventas, 5)

top5_frutas_verduras
```

\nolinenumbers

**Pregunta 3 : Si consideramos la categoría de PESCADO. Cuáles son los 5 productos más vendidos ? ¿Cuántos kilos se han vendido de cada uno de estos productos?**

\linenumbers

```{r}

```


\nolinenumbers

**Pregunta 4 : Muestra mediante un gráfico de líneas como ha variado el precio por kilo de las bananas y los plátanos en los tickets disponibles, a lo largo del tiempo.**

\linenumbers

```{r}

```

\nolinenumbers

**Pregunta 5  :¿Cuál es la procedencia de los tickets?¿ Qué ciudad/ pueblo tiene un mayor número de tickets ? **

\linenumbers

```{r}

```
\nolinenumbers

**Pregunta 6  : Muestra mediante un diagrama el número de tickets recogidos cada día de las semana. ¿Si tuvieses que cerrar un día entre semana qué día lo harías?  **
```{r}
df_h %>%
  mutate(dia_semana = wday(Fecha, label = TRUE, abbr = FALSE, week_start = 1)) %>% # lunes como primer día
  group_by(dia_semana) %>%
  summarise(n_tickets = n()) %>%
  arrange(desc(n_tickets)) %>%
  ggplot(aes(x = dia_semana, y = n_tickets)) +
  geom_col(fill = "lightblue") +
  labs(
    title = "Número de tickets por día de la semana",
    x = "Día de la semana",
    y = "Número de tickets"
  ) +
  theme_minimal()

df_h %>%
  mutate(dia_semana = wday(Fecha, label = TRUE, abbr = FALSE, week_start = 1)) %>% # lunes como primer día
  filter(dia_semana == "domingo")
```

Según el diagrama el día entre semana con menos tickets y por lo tanto ventas, es el jueves. Por lo que lo más inteligente sería cerrar este día, ya que es cuando menos gente va a Mercadona.


\linenumbers

## Resto de preguntas propuestas:

\nolinenumbers


**Pregunta 7 : ¿Cuál es la hora más habitual para realizar la compra? ¿Este horario varía entre los días laborales y los fines de semana? **

\linenumbers

```{r}

```

\nolinenumbers


**Pregunta 8 : ¿Existe alguna diferencia clara en el perfil de compra entre los días de semana y los fines de semana? **

\linenumbers

```{r}

```

\nolinenumbers


**Pregunta 9 : ¿El precio total de la compra varían según la ciudad o zona? **

\linenumbers

```{r}

```

\nolinenumbers


**Pregunta 10 : ¿Cuánto dinero de media se gasta cada cliente en una compra?  **

\linenumbers

```{r}

```

\nolinenumbers


**Pregunta 11 : ¿Cuál es el mes o período en el que más gastos se realizan? ¿Durante las vacaciones de navidad?  **

\linenumbers

Para resolver esta pregunta podemos realizar un gráfico de barras para observar mejor la información. En este gráfico se representan los datos de distintos tickets de 3 años diferentes (2023, 2024 y 2025). Al tener diferentes cantidades de tickets por mes de un año a otro, tenemos que decir un período por cada año de tickets (en este caso 3 meses). Por lo que este período no tiene porque coincidir todos los años. 

```{r}
library(lubridate)

# Extraemos el mes y año de la fecha
df_h <- df_h %>%
  mutate(Mes = month(Fecha, label = TRUE),
         Año = year(Fecha))

# Agrupamos por año y mes, y sumamos el gasto
gastos_mensuales <- df_h %>%
  group_by(Año, Mes) %>%
  summarise(Gasto_Total = sum(TOTAL_PAGO, na.rm = TRUE)) %>%
  arrange(desc(Gasto_Total))

head(gastos_mensuales)

# Realizamos una gráfica para visualizar que mes es en el que más gastos se realizan.
ggplot(gastos_mensuales, aes(x = Mes, y = Gasto_Total, fill = as.factor(Año))) +
  geom_bar(stat = "identity", position = "dodge") + 
  labs(title = "Gasto total por mes",
       x = "Mes",
       y = "Gasto (€)") +
  theme_minimal()

#Usamos stat = "identity" para indicar que ya dimos los valores y position="dodge" para tener en el mismo mes varias barras en el caso de tener tickets de varios. años.

```
Si nos fijamos en los tickets del año 2023 (color rosa) el mes con más gastos es diciembre. Fijandonos en el año 2024 (verde), el período con más gastos es en enero (siendo el único año con tickets todos los meses). En el año 2025 (azul) es febrero el mes con más gastos. Por lo que el período con más gastos no es en la época de Navidad.


\nolinenumbers


**Pregunta 12 : ¿Qué productos suelen comprarse juntos?  **

\linenumbers

```{r}
library(dplyr)

# Filtramos solo las columnas importantes y eliminamos los duplicados por ticket
df_limpio <- df_p %>%
  filter(!is.na(Descripcion)) %>%
  select(index, Descripcion) %>%
  distinct()

coocurrencias <- df_limpio %>%
  inner_join(df_limpio, by = "index") %>%
  filter(Descripcion.x != Descripcion.y) %>% 
  group_by(Descripcion.x, Descripcion.y) %>%
  summarise(Frecuencia = n(), .groups = "drop") %>%
  arrange(desc(Frecuencia))

head(coocurrencias, 10)
```
Se observa que "almendra natural" se suele comprar con "cacahuete chocolate", "pepino" o "barrita muesli choco" y el "pan semillas" con "atun claro oliva". Esto también ocurre a la viceversa.

\nolinenumbers


**Pregunta 13 : ¿Cuál es el producto más caro registrado en los tickets? **

\linenumbers

```{r}
df_p$Importe <- as.numeric(df_p$Importe)

# Encontrar la fila con el mayor importe, usando slice para seleccionar la 1 fila.
producto_mas_caro <- df_p %>%
  filter(!is.na(Importe)) %>%
  arrange(desc(Importe)) %>%
  slice(1)

producto_mas_caro
```
El producto más caro registrado es el "alistado mediano", que tiene un precio de 31.33 euros.

\nolinenumbers


**Pregunta 14 : ¿Hay una cantidad  media de productos por tickets?  **

\linenumbers

```{r}
df_p$Cantidad <- as.numeric(df_p$Cantidad)

# Agrupar por ticket y sumar cantidades de productos por ticket
productos_por_ticket <- df_p %>%
  group_by(index) %>%
  summarise(Total_Productos = sum(Cantidad, na.rm = TRUE))

media_productos <- mean(productos_por_ticket$Total_Productos)

media_productos
```
La cantidad media de productos por ticket es de 18.80198 productos.

\nolinenumbers


**Pregunta 15 : ¿Qué productos son los más comprados en las diferentes partes del día: mañana, tarde y noche?  **

\linenumbers

```{r}

```

\nolinenumbers


**Pregunta 16 : ¿Que productos son los más comprados durante las diferentes estaciones, verano (21 de junio - 22 de septiempre),  invierno(21 diciembre - 20 marzo)... ? (representación gráfica) **

\linenumbers

```{r}

```

\nolinenumbers


**Pregunta 17 : ¿En que estación se compra más?¿Por que crees que és?**

\linenumbers

```{r}

```

\nolinenumbers


**Pregunta 18 :¿Cuánto supone económicamente de media el IVA en las compras?**

\linenumbers

```{r}

```

\nolinenumbers


**Pregunta 19 : ¿De los 5 productos más comprados, cual de ellos ha subido más el precio?¿y cual ha bajado más su precio? **

\linenumbers

```{r}

```

\nolinenumbers


**Pregunta 20 : ¿En que se ha gastado(€) más en pescado o en otros productos que van por peso? ¿Es equivalente al número de veces que se han comprado unidades de estos?**

\linenumbers

```{r}

```

\nolinenumbers


**Pregunta 21 :¿Hay una relación entre la cantidad de productos que se compra y si ha utilizado el parking o no? **

\linenumbers

```{r}
# Crear df_parking con la información del uso del parking
df_parking <- df_h %>%
  select(index, PARKING_ENTRADA) %>%
  mutate(usado_parking = PARKING_ENTRADA != "00:00") %>%
  select(index, usado_parking)

# Unir con df_p y contar productos distintos por ticket
productos_por_ticket <- df_p %>%
  left_join(df_parking, by = "index") %>%
  group_by(index, usado_parking) %>%
  summarise(num_productos = n())

# Calcular estadísticas de comparación
usado_parking_df <- productos_por_ticket %>%
  group_by(usado_parking) %>%
  summarise(mediana_prod = median(num_productos),total_prod = n())

usado_parking_df

```

Como se ve en el dataframe, cuando no se utiliza el parking, el número de productos es más bajo (mediana = 13). Cuando se utiliza el parking, el número de productos es más alto (mediana = 19).

Por lo que podemos concluir, que cuando se utiliza el parking es más probable que se compren más productos que si no se utiliza.


\nolinenumbers


**Pregunta 22 : ¿Cual es el tiempo medio que tardan en hacer la compra las personas que han utilizado el parking? **

\linenumbers

```{r}
df_parking_tiempos <- df_h %>%
  select(PARKING_ENTRADA, PARKING_SALIDA) %>%
  filter(PARKING_ENTRADA != "00:00") %>%
  mutate(
    # Convertir las horas de entrada y salida a formato tiempo
    PARKING_ENTRADA = as.POSIXct(PARKING_ENTRADA, format = "%H:%M", tz = "UTC"),
    PARKING_SALIDA = as.POSIXct(PARKING_SALIDA, format = "%H:%M", tz = "UTC"),
    
    # Calcular la diferencia en minutos
    tiempo_diferencia = as.numeric(PARKING_SALIDA - PARKING_ENTRADA)
  )

# Calcular el tiempo medio
tiempo_medio <- mean(df_parking_tiempos$tiempo_diferencia, na.rm = TRUE)
tiempo_medio
```

El tiempo medio que tardan en hacer la compra las personas que utilizan el parking es de 28 minutos y medio aproximadamente.


\nolinenumbers



