---
title: "Importacion"
author: "Josep Vicent MORALES"
date: "2025-04-03"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1.Librerias

Conjunto de librerías a utilizar

```{r results='hide'}
library(pdftools)
library(tidyr)
library(dplyr)
library(ggplot2)
```

## 2. Carga Pdfs

Los tickets que queremos analizar se encuentran en formato .pdf, y se encuentran en la carpeta data, por tanto en este bloque importamos todos los .pdf de la carpeta.

```{r results='hide'}
dir <- "data/"
# Charge all pdfs from folder data
pdfs <- list.files(path = dir, pattern = "\\.pdf$", full.names = TRUE)%>%
        lapply(pdf_text)
```

## 3. Transformación

En este apartado realizamos el tratamiento de los datos para dividirlos y reorganizarlos para posteriormente poder consultarlos de manera más fácil y eficiente.

En este bloque dividimos los tiquets por líneas para poder extraer por partes las zonas de interes.

```{r results='hide'}
dt <- lapply(pdfs, function(pdf) {unlist(strsplit(pdf, "\n"))})
```

### 3.1 Tabla Precios

Como las comidas que van por peso como verduras frutas o pescados, se organizan de otra manera en los tickets, mostrandose en una líena la cantidad, y el nombre del elemento, y en la de abajo se muestra el peso del elemento en Kg, seguido del precio en Kg/€ y finalmente a la derecha el precio pagado, se ha creado esta función para poder implementarlo en nuestra tabla.

```{r}
weight_food <- function(df, end){
            r_remove <- c()
            
            for (i in c(12:(end - 1))) {
              if (i < nrow(df) && is.na(df$Precio[i]) && 
                  (is.na(df$Cantidad[i + 1]) || df$Cantidad[i + 1] == "")) {
                  df$Precio[i] <- gsub("[^0-9,]","",df$Precio[i + 1])
                  df$Importe[i] <- gsub("[^0-9,]","",df$Importe[i + 1])
                  df$Peso[i] <- gsub("[^0-9,]","",df$Descripcion[i + 1])
                  # Rows to remove
                  r_remove <- c(r_remove, i+1)
              }
            }
            # Eliminates rows where weight was written
            if (length(r_remove)>0){
              df <- df[-r_remove,]
            }
            return(df)
          }
```

Extraemos por completo los datos referentes a los elementos comprados precios y unidades, y se transforma en una tabla esto se realiza para todos los distintos tickets.

```{r results='hide'}

# ^ indica inicio cadena
# \\s indica espacio
# *$ indica hasta el final
# Busca a partir de cabecera tabla pagos una línea vacía 
endTabl <- lapply(dt, function(x) {
  min(which(grepl("^\\s*$", x[12:length(x)])) +11)
  }) %>% unlist


df <- lapply(seq_along(dt), function(i) {
  a <- dt[[i]]  # Extraer el texto del PDF i
  end <- endTabl[i] - 1  # Obtener la posición de endTabl para este PDF
  
  # Convertir a data.frame solo las líneas relevantes
  df <- as.data.frame(
    # \\s indica cualquier espacio en blanco
    # {2,} indica al menos 2 veces seguidas
    do.call(rbind, lapply(strsplit(a[12:end], "\\s{2,}"), function(x) {
      length(x) <- 5  # Asegurar que cada fila tenga 5 elementos
      return(x)
    })), 
    stringsAsFactors = FALSE
  )
  # Column names asignation
  colnames(df) <- c("Cantidad", "Descripcion", "Precio", "Importe", "Peso")
  
  # Clear up food with weigth information
  df <- weight_food(df, end)
  
  return(df)
})

```

Estos datos presentan algunos problemas, entre ellos, los decimales estan separados por "," en vez de por ".", y a su vez, las tablas no estan llenas de datos, ya que algunos datos del Importe salen desplazados a la columna de Precio debido a que esta está vacía cuando la cantidad de unidades es 1 ya que es el mismo valor, por tanto en el siguiente bloque arreglaremos estos 2 problemas.

```{r results='hide'}
df <- lapply(df, function(df) {
  df %>%
    # Change <NA> in Importe to Precio
    mutate(Importe = ifelse(is.na(Importe), Precio, Importe)) %>%
    # Change "," to "." and change type to numeric
    mutate(across(-Descripcion, ~ as.numeric(gsub(",", ".", .))))
}) 
```
